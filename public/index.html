<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>誰の生まれ変わり？診断</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap');

        :root {
            --primary-color: #6a4bc4;
            --primary-dark: #5035a5;
            --secondary-color: #ffd166;
            --text-color: #333;
            --bg-color: #f5f5f5;
            --card-color: #fff;
            --accent-color: #ef476f;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--bg-color);
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1IiBoZWlnaHQ9IjUiPgo8cmVjdCB3aWR0aD0iNSIgaGVpZ2h0PSI1IiBmaWxsPSIjZmZmIj48L3JlY3Q+CjxyZWN0IHdpZHRoPSIxIiBoZWlnaHQ9IjEiIGZpbGw9IiNmMGYwZjAiPjwvcmVjdD4KPC9zdmc+');
        }

        h1, h2, h3 {
            color: var(--primary-color);
            font-weight: 700;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 2.2em;
            position: relative;
            padding-bottom: 15px;
        }

        h1::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background-color: var(--secondary-color);
            border-radius: 3px;
        }

        .subtitle {
            text-align: center;
            font-size: 1.2em;
            margin-bottom: 30px;
            color: #666;
        }

        .container {
            background: var(--card-color);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            transition: transform 0.3s, box-shadow 0.3s;
            overflow: hidden;
        }

        .container:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(106, 75, 196, 0.1);
        }

        label {
            display: block;
            margin-top: 20px;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--primary-color);
        }

        input, select {
            width: 100%;
            padding: 12px 15px;
            margin-top: 5px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            background-color: #f9f9f9;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(106, 75, 196, 0.1);
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 14px 20px;
            margin-top: 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            width: 100%;
            transition: background-color 0.3s, transform 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        /* 宇宙を演出するローディングアニメーション */
        .loading {
            text-align: center;
            margin: 20px 0;
            display: none;
            position: relative;
            height: 300px;
            overflow: hidden;
            border-radius: 12px;
            background: linear-gradient(135deg, #000000, #1a0033);
        }

        .loading::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            background-image:
                radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 2px),
                radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 1px),
                radial-gradient(white, rgba(255,255,255,.1) 2px, transparent 2px),
                radial-gradient(rgba(255,255,255,.4), rgba(255,255,255,.1) 2px, transparent 2px);
            background-size: 550px 550px, 350px 350px, 250px 250px, 150px 150px;
            background-position: 0 0, 40px 60px, 130px 270px, 70px 100px;
            animation: stars 5s linear infinite;
        }

        @keyframes stars {
            0% {
                transform: rotate(0deg) scale(1.0);
                opacity: 0.8;
            }
            50% {
                opacity: 1;
            }
            100% {
                transform: rotate(360deg) scale(1.5);
                opacity: 0.8;
            }
        }

        .cosmic-body {
            position: absolute;
            width: 120px;
            height: 120px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #fdf6c5, #ffcb05 40%, #ff5e00 70%, #6a4bc4);
            box-shadow: 0 0 60px 30px rgba(255, 203, 5, 0.3),
                        0 0 100px 60px rgba(255, 94, 0, 0.3),
                        0 0 140px 90px rgba(106, 75, 196, 0.3);
            animation: pulse 3s ease-in-out infinite;
        }

        .orbit {
            position: absolute;
            top: 50%;
            left: 50%;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }

        .orbit:nth-child(1) {
            width: 240px;
            height: 240px;
            animation: rotate 10s linear infinite;
        }

        .orbit:nth-child(2) {
            width: 200px;
            height: 200px;
            animation: rotate 15s linear infinite reverse;
        }

        .orbit:nth-child(3) {
            width: 160px;
            height: 160px;
            animation: rotate 20s linear infinite;
        }

        .satellite {
            position: absolute;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: white;
            box-shadow: 0 0 10px 2px rgba(255, 255, 255, 0.6);
        }

        .orbit:nth-child(1) .satellite {
            top: 0;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .orbit:nth-child(2) .satellite {
            top: 50%;
            right: 0;
            transform: translate(50%, -50%);
        }

        .orbit:nth-child(3) .satellite {
            bottom: 0;
            left: 50%;
            transform: translate(-50%, 50%);
        }

        @keyframes rotate {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.05); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        .loading-text {
            position: absolute;
            bottom: 30px;
            left: 0;
            right: 0;
            color: white;
            font-size: 1.2em;
            font-weight: 500;
            letter-spacing: 1px;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.7);
            animation: pulse-text 2s ease-in-out infinite;
        }

        @keyframes pulse-text {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }

        .result {
            margin-top: 30px;
            padding: 25px;
            background-color: #f9f9f9;
            border-left: 5px solid var(--primary-color);
            border-radius: 12px;
            display: none;
            animation: fadeIn 1s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result h2 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.6em;
            position: relative;
            padding-bottom: 10px;
        }

        .result h2::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 40px;
            height: 3px;
            background-color: var(--secondary-color);
            border-radius: 3px;
        }

        .result-item {
            margin-bottom: 30px;
            padding: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s;
        }

        .result-item:hover {
            transform: translateY(-5px);
        }

        .person-name {
            font-weight: 700;
            font-size: 1.3em;
            color: var(--primary-color);
            margin-bottom: 10px;
            border-bottom: 1px dashed #ddd;
            padding-bottom: 8px;
        }

        .reason-list {
            margin: 15px 0;
            padding-left: 20px;
        }

        .reason-list li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .error {
            color: var(--accent-color);
            text-align: center;
            display: none;
            padding: 20px;
            background-color: #fff8f8;
            border-radius: 8px;
            border-left: 5px solid var(--accent-color);
            margin-top: 20px;
        }

        footer {
            margin-top: 40px;
            text-align: center;
            font-size: 0.9em;
            color: #7f8c8d;
            padding: 20px 0;
            border-top: 1px solid #eee;
        }

        .share-section {
            margin-top: 30px;
            text-align: center;
            display: none;
            padding: 20px;
            background-color: #f5f9ff;
            border-radius: 12px;
        }

        .share-section h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .share-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }

        .share-button {
            background-color: #2ecc71;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 0;
            transition: background-color 0.3s, transform 0.3s;
            width: auto;
            display: inline-flex;
            align-items: center;
        }

        .share-button svg {
            margin-right: 8px;
        }

        .share-button.twitter {
            background-color: #1da1f2;
        }

        .share-button.line {
            background-color: #06c755;
        }

        .share-button.copy {
            background-color: #6c757d;
        }

        .share-button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .restart-button {
            background-color: #95a5a6;
            margin-top: 20px;
        }

        .restart-button:hover {
            background-color: #7f8c8d;
        }

        /* 星のきらめき効果 */
        .star {
            position: fixed;
            width: 2px;
            height: 2px;
            background-color: white;
            border-radius: 50%;
            animation: twinkle 5s infinite;
            z-index: -1;
        }

        @keyframes twinkle {
            0% { opacity: 0; }
            50% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* レスポンシブデザイン */
        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 1.8em;
            }

            .subtitle {
                font-size: 1em;
            }

            .share-buttons {
                flex-direction: column;
                align-items: center;
            }

            .share-button {
                width: 80%;
                margin-bottom: 10px;
            }
        }

                /* ここに新しいCSSルールを追加 */
        .destiny-content {
            line-height: 1.8;
            white-space: pre-line;
        }

        .destiny-content strong,
        .reason-list strong {
            color: var(--primary-color);
            font-weight: 700;
        }

        .reason-list li {
            margin-bottom: 12px;
        }
    </style>
</head>
<body>
    <h1>運命診断アプリ</h1>
    <div class="subtitle">あなたの前世と天命を星々が教えてくれる</div>

    <div class="container">
        <div id="form-section">
            <label for="name">名前（漢字・ひらがな）:</label>
            <input type="text" id="name" placeholder="あなたのお名前を入力" required>

            <label for="birthdate">生年月日:</label>
            <input type="date" id="birthdate" required>

            <label for="mbti">MBTIタイプ:</label>
            <select id="mbti" required>
                <option value="">選択してください</option>
                <option value="INTJ">INTJ - 建築家</option>
                <option value="INTP">INTP - 論理学者</option>
                <option value="ENTJ">ENTJ - 指揮官</option>
                <option value="ENTP">ENTP - 討論者</option>
                <option value="INFJ">INFJ - 提唱者</option>
                <option value="INFP">INFP - 仲介者</option>
                <option value="ENFJ">ENFJ - 主人公</option>
                <option value="ENFP">ENFP - 広報運動家</option>
                <option value="ISTJ">ISTJ - 管理者</option>
                <option value="ISFJ">ISFJ - 擁護者</option>
                <option value="ESTJ">ESTJ - 幹部</option>
                <option value="ESFJ">ESFJ - 領事官</option>
                <option value="ISTP">ISTP - 巨匠</option>
                <option value="ISFP">ISFP - 冒険家</option>
                <option value="ESTP">ESTP - 起業家</option>
                <option value="ESFP">ESFP - エンターテイナー</option>
            </select>

            <button id="analyze">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;"><circle cx="12" cy="12" r="10"></circle><path d="M16.2 7.8l-2 6.3-6.4 2.1 2-6.3z"></path></svg>
                運命を診断する
            </button>
        </div>

        <div class="loading" id="loading">
            <div class="orbit"><div class="satellite"></div></div>
            <div class="orbit"><div class="satellite"></div></div>
            <div class="orbit"><div class="satellite"></div></div>
            <div class="cosmic-body"></div>
            <div class="loading-text">宇宙の彼方からあなたの運命を読み解いています...</div>
        </div>

        <div class="error" id="error">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 10px; vertical-align: middle;"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
            エラーが発生しました。しばらくしてからもう一度お試しください。
        </div>

        <div class="result" id="result">
            <h2>あなたの天命</h2>
            <div id="destiny-result"></div>

            <h2 style="margin-top: 30px;">あなたの前世</h2>
            <p>以下の歴史上の人物の魂があなたに宿っている可能性が高いです：</p>
            <div id="reincarnation-result"></div>

            <div class="share-section" id="share-section">
                <h3>結果をシェアする</h3>
                <p>あなたの運命診断結果を友達と共有しましょう！</p>
                <div class="share-buttons">
                    <button class="share-button twitter" id="share-twitter">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 4s-.7 2.1-2 3.4c1.6 10-9.4 17.3-18 11.6 2.2.1 4.4-.6 6-2C3 15.5.5 9.6 3 5c2.2 2.6 5.6 4.1 9 4-.9-4.2 4-6.6 7-3.8 1.1 0 3-1.2 3-1.2z"></path></svg>
                        Twitter
                    </button>
                    <button class="share-button line" id="share-line">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v14c0 1.1.9 2 2 2h3m8-4h3a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-3M12 8v8m-4-4h8"></path></svg>
                        LINE
                    </button>
                    <button class="share-button copy" id="copy-url">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                        URLをコピー
                    </button>
                </div>
            </div>

            <button class="restart-button" id="restart">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
                もう一度診断する
            </button>
        </div>
    </div>

    <footer>
        <p>© 2025 運命診断アプリ - 星々の導きと魂の記憶</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 星のきらめき効果を作成
            for (let i = 0; i < 50; i++) {
                createStar();
            }

            // DOM要素
            const formSection = document.getElementById('form-section');
            const loadingSection = document.getElementById('loading');
            const errorSection = document.getElementById('error');
            const resultSection = document.getElementById('result');
            const shareSection = document.getElementById('share-section');

            const nameInput = document.getElementById('name');
            const birthdateInput = document.getElementById('birthdate');
            const mbtiSelect = document.getElementById('mbti');

            const analyzeButton = document.getElementById('analyze');
            const restartButton = document.getElementById('restart');

            // 診断実行
            analyzeButton.addEventListener('click', async function() {
                // 入力値の取得
                const name = nameInput.value;
                const birthdate = birthdateInput.value;
                const mbti = mbtiSelect.value;

                // バリデーション
                if (!name || !birthdate || !mbti) {
                    alert('すべての項目を入力してください');
                    return;
                }

                // 日付の整形
                const date = new Date(birthdate);
                const formattedDate = `${date.getFullYear()}年${(date.getMonth() + 1).toString().padStart(2, '0')}月${date.getDate().toString().padStart(2, '0')}日`;

                // 読み込み表示
                formSection.style.display = 'none';
                loadingSection.style.display = 'block';
                loadingSection.querySelector('.loading-text').textContent = '宇宙の彼方からあなたの天命を読み解いています...';
                resultSection.style.display = 'none';
                errorSection.style.display = 'none';

                try {
                    // 第一段階: 天命診断
                    const destinyResponse = await fetch('/api/analyze', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            name: name,
                            birthdate: formattedDate,
                            mbti: mbti,
                            stage: 'destiny'
                        })
                    });

                    if (!destinyResponse.ok) {
                        throw new Error('API request failed');
                    }

                    const destinyData = await destinyResponse.json();

                    if (destinyData.error) {
                        throw new Error(destinyData.error);
                    }

                    // 天命結果の表示
                    document.getElementById('destiny-result').innerHTML = `<div class="destiny-content">${destinyData.result}</div>`;

                    // 結果の一部表示（天命のみ）
                    loadingSection.style.display = 'none';
                    resultSection.style.display = 'block';
                    document.querySelector('h2:nth-of-type(2)').style.display = 'none'; // 前世の見出しを隠す
                    document.querySelector('#result > p').style.display = 'none'; // 前世の説明を隠す
                    document.getElementById('reincarnation-result').style.display = 'none';

                    // 前世診断中の表示
                    loadingSection.style.display = 'block';
                    loadingSection.querySelector('.loading-text').textContent = '過去世の可能性を探索しています...';

                    // 第二段階: 前世診断
                    const pastLifeResponse = await fetch('/api/analyze', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            name: name,
                            birthdate: formattedDate,
                            mbti: mbti,
                            stage: 'pastlife',
                            destinyData: destinyData.result
                        })
                    });

                    if (!pastLifeResponse.ok) {
                        throw new Error('Past life API request failed');
                    }

                    const pastLifeData = await pastLifeResponse.json();

                    if (pastLifeData.error) {
                        throw new Error(pastLifeData.error);
                    }

                    // 前世結果の表示
                    let reincarnationHtml = '';
                    pastLifeData.reincarnations.forEach((person, index) => {
                        reincarnationHtml += `
                            <div class="result-item">
                                <div class="person-name">${index + 1}. ${person.name}（${person.years}）</div>
                                <div><strong>理由:</strong></div>
                                <ul class="reason-list">
                                    ${person.reasons.map(reason => `<li>${reason}</li>`).join('')}
                                </ul>
                                <p>${person.conclusion}</p>
                            </div>
                        `;
                    });

                    document.getElementById('reincarnation-result').innerHTML = reincarnationHtml;

                    // 完全な結果表示
                    loadingSection.style.display = 'none';
                    resultSection.style.display = 'block';
                    document.querySelector('h2:nth-of-type(2)').style.display = 'block'; // 前世の見出しを表示
                    document.querySelector('#result > p').style.display = 'block'; // 前世の説明を表示
                    document.getElementById('reincarnation-result').style.display = 'block';
                    shareSection.style.display = 'block';

                    // URLパラメータの設定（共有用）
                    const resultId = pastLifeData.resultId || destinyData.resultId;
                    if (resultId) {
                        const shareUrl = `${window.location.origin}${window.location.pathname}?result=${resultId}&name=${encodeURIComponent(name)}`;
                        setupShareButtons(shareUrl, name);

                        // URLを更新（履歴に追加）
                        const newUrl = `${window.location.pathname}?result=${resultId}&name=${encodeURIComponent(name)}`;
                        window.history.pushState({ path: newUrl }, '', newUrl);
                    }

                } catch (error) {
                    console.error('Error:', error);
                    loadingSection.style.display = 'none';
                    errorSection.style.display = 'block';

                    // 5秒後にフォームに戻る
                    setTimeout(() => {
                        errorSection.style.display = 'none';
                        formSection.style.display = 'block';
                    }, 5000);
                }
            });



            // やり直しボタン
            restartButton.addEventListener('click', function() {
                // フォームをリセット
                nameInput.value = '';
                birthdateInput.value = '';
                mbtiSelect.value = '';

                // 表示切替
                resultSection.style.display = 'none';
                formSection.style.display = 'block';

                // URLをリセット
                window.history.pushState({}, '', window.location.pathname);
            });

            // シェアボタンの設定
            function setupShareButtons(shareUrl, name) {
                // Twitterシェア
                document.getElementById('share-twitter').addEventListener('click', function() {
                    const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(`私の前世診断結果：${name}の前世を診断しました！`)}&url=${encodeURIComponent(shareUrl)}`;
                    window.open(twitterUrl, '_blank');
                });

                // LINEシェア
                document.getElementById('share-line').addEventListener('click', function() {
                    const lineUrl = `https://line.me/R/msg/text/?${encodeURIComponent(`私の前世診断結果：${name}の前世を診断しました！ ${shareUrl}`)}`;
                    window.open(lineUrl, '_blank');
                });

                // URLコピー
                document.getElementById('copy-url').addEventListener('click', function() {
                        navigator.clipboard.writeText(shareUrl).then(() => {
                       alert('URLをクリップボードにコピーしました！');
                   }).catch(err => {
                       console.error('クリップボードへのコピーに失敗しました', err);
                   });
               });
           }

           // 星のきらめき効果を作成する関数
           function createStar() {
               const star = document.createElement('div');
               star.classList.add('star');

               // ランダムな位置
               const x = Math.random() * window.innerWidth;
               const y = Math.random() * window.innerHeight;

               star.style.left = `${x}px`;
               star.style.top = `${y}px`;

               // ランダムなサイズとアニメーション遅延
               const size = Math.random() * 2 + 1;
               const delay = Math.random() * 5;

               star.style.width = `${size}px`;
               star.style.height = `${size}px`;
               star.style.animationDelay = `${delay}s`;

               document.body.appendChild(star);
           }

           // URL検索パラメータのチェック（結果共有表示用）
           const urlParams = new URLSearchParams(window.location.search);
           const resultParam = urlParams.get('result');
           const nameParam = urlParams.get('name');

           if (resultParam) {
               // 結果IDがある場合、共有されたURLと見なす
               formSection.style.display = 'none';
               loadingSection.style.display = 'block';

               // APIからデータを取得
               fetch(`/api/result/${resultParam}`)
                   .then(response => {
                       if (!response.ok) {
                           throw new Error('Result not found');
                       }
                       return response.json();
                   })
                   .then(data => {
                       // 結果の表示
                       document.getElementById('destiny-result').innerHTML = `<p>${data.destiny}</p>`;

                       let reincarnationHtml = '';
                       data.reincarnations.forEach((person, index) => {
                           reincarnationHtml += `
                               <div class="result-item">
                                   <div class="person-name">${index + 1}. ${person.name}（${person.years}）</div>
                                   <div><strong>あなたとの共通点:</strong></div>
                                   <ul class="reason-list">
                                       ${person.reasons.map(reason => `<li>${reason}</li>`).join('')}
                                   </ul>
                                   <p>${person.conclusion}</p>
                               </div>
                           `;
                       });

                       document.getElementById('reincarnation-result').innerHTML = reincarnationHtml;

                       // 結果セクションの表示
                       loadingSection.style.display = 'none';
                       resultSection.style.display = 'block';
                       shareSection.style.display = 'block';

                       // シェアボタンの設定
                       const shareUrl = window.location.href;
                       setupShareButtons(shareUrl, nameParam || '');
                   })
                   .catch(error => {
                       console.error('Error loading result:', error);
                       loadingSection.style.display = 'none';
                       formSection.style.display = 'block';
                       alert('診断結果が見つかりませんでした。新しく診断してください。');
                   });
           }
       });
   </script>
</body>
</html>